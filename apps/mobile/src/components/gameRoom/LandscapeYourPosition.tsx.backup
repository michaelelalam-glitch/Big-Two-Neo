/**
 * LandscapeYourPosition Component
 * 
 * Bottom player position with card hand display for landscape mode
 * 
 * Features:
 * - Player profile display (name + card count badge)
 * - Horizontal card hand with adaptive overlap
 * - 72×104pt cards (1.4444 aspect ratio)
 * - 50% overlap (36pt spacing) by default
 * - Lift-up selection animation
 * - Touch-optimized (44pt minimum target)
 * 
 * Task #452: Build bottom player position with card hand display
 * Date: December 19, 2025
 */

import React, { useMemo, useState, useCallback } from 'react';
import { View, Text, StyleSheet } from 'react-native';
import type { Card as CardType } from '../../game/types';
import Card from '../game/Card';
import { i18n } from '../../i18n';
import * as Haptics from 'expo-haptics';

// ============================================================================
// TYPE DEFINITIONS
// ============================================================================

interface LandscapeYourPositionProps {
  /** Player name */
  playerName: string;
  /** Player's cards */
  cards: CardType[];
  /** Selected card IDs */
  selectedCardIds: Set<string>;
  /** Selection change handler (matches portrait CardHand behavior - Task #457) */
  onSelectionChange: (ids: Set<string>) => void;
  /** Is player's turn */
  isActive: boolean;
  /** Disabled state */
  disabled?: boolean;
  /** Container width for adaptive overlap */
  containerWidth?: number;
}

// ============================================================================
// MAIN COMPONENT
// ============================================================================

export function LandscapeYourPosition({
  playerName,
  cards,
  selectedCardIds,
  onSelectionChange,
  isActive,
  disabled = false,
  containerWidth = 932, // Default: iPhone 17 landscape width
}: LandscapeYourPositionProps) {
  
  // Handle card toggle selection (matches portrait CardHand - Task #457)
  const handleCardPress = React.useCallback((cardId: string) => {
    if (disabled) return;
    
    const newSelection = new Set(selectedCardIds);
    if (newSelection.has(cardId)) {
      newSelection.delete(cardId);
    } else {
      newSelection.add(cardId);
    }
    onSelectionChange(newSelection);
  }, [disabled, selectedCardIds, onSelectionChange]);
  // Calculate adaptive card overlap (tighter spacing for better fit)
  const { cardSpacing, totalWidth } = useMemo(() => {
    return calculateCardOverlap(
      cards.length,
      72, // Card width
      containerWidth - 40, // Available width (minus padding)
      24, // Preferred spacing (33% overlap for tighter fit)
      16  // Minimum spacing
    );
  }, [cards.length, containerWidth]);

  // Empty state (no cards)
  if (cards.length === 0) {
    return (
      <View style={styles.container}>
        <View style={styles.playerInfo}>
          <Text style={[styles.playerName, isActive && styles.playerNameActive]}>
            {playerName}
          </Text>
        </View>
        <View style={styles.emptyState}>
          <Text style={styles.emptyText}>{i18n.t('game.noCards')}</Text>
        </View>
      </View>
    );
  }

  return (
    <View style={styles.container} testID="landscape-your-position">
      {/* Player Info Row */}
      <View style={styles.playerInfo}>
        <Text style={[styles.playerName, isActive && styles.playerNameActive]}>
          {playerName}
        </Text>
      </View>

      {/* Card Hand */}
      <View 
        style={[styles.cardsContainer, { width: totalWidth }]}
        testID="cards-container"
      >
        {cards.map((card, index) => {
          const isSelected = selectedCardIds.has(card.id);
          
          return (
            <Pressable
              key={card.id}
              style={[
                styles.cardWrapper,
                {
                  marginLeft: index > 0 ? cardSpacing : 0,
                  zIndex: isSelected ? 1000 + index : index,
                  transform: [{ translateY: isSelected ? -20 : 0 }], // Lift selected cards (Task #457)
                },
              ]}
              onPress={() => handleCardPress(card.id)}
              disabled={disabled}
              testID={`card-${card.id}`}
              accessibilityRole="button"
              accessibilityLabel={`${card.rank} of ${card.suit}`}
              accessibilityState={{ selected: isSelected, disabled }}
            >
              <LandscapeCard 
                card={card}
                size="base" // 72×104pt for player hand
              />
            </Pressable>
          );
        })}
      </View>
    </View>
  );
}

// ============================================================================
// STYLES
// ============================================================================

const styles = StyleSheet.create({
  container: {
    alignItems: 'center',
    paddingHorizontal: 20,
    paddingVertical: 12,
  },

  // Player info row
  playerInfo: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    marginBottom: 8,
    gap: 8,
  },

  playerName: {
    fontSize: 16,
    fontWeight: '600',
    color: '#ffffff',
  },

  playerNameActive: {
    color: '#10b981', // Green for active player
    fontWeight: '700',
  },

  // Cards container
  cardsContainer: {
    flexDirection: 'row',
    alignItems: 'flex-end', // Align cards to bottom
    justifyContent: 'center',
    minHeight: 104, // Card height
  },

  cardWrapper: {
    // Positioning and z-index applied inline
  },

  // Empty state
  emptyState: {
    padding: 24,
    backgroundColor: 'rgba(255, 255, 255, 0.05)',
    borderRadius: 16,
    borderWidth: 2,
    borderColor: 'rgba(255, 255, 255, 0.1)',
    borderStyle: 'dashed',
    minHeight: 104,
    justifyContent: 'center',
    alignItems: 'center',
  },

  emptyText: {
    color: 'rgba(255, 255, 255, 0.5)',
    fontSize: 14,
    fontStyle: 'italic',
    textAlign: 'center',
  },
});

export default LandscapeYourPosition;
